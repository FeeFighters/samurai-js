<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>payment_error_handler.js.coffee</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
        
          
          <a class="source" href="../samurai.js.coffee.html">0.1/samurai.js.coffee</a>
        
          
          <a class="source" href="base.js.coffee.html">0.1/samurai/base.js.coffee</a>
        
          
          <a class="source" href="card_preview.js.coffee.html">0.1/samurai/card_preview.js.coffee</a>
        
          
          <a class="source" href="expiration_dates.js.coffee.html">0.1/samurai/expiration_dates.js.coffee</a>
        
          
          <a class="source" href="payment_error_handler.js.coffee.html">0.1/samurai/payment_error_handler.js.coffee</a>
        
          
          <a class="source" href="payment_forms.js.coffee.html">0.1/samurai/payment_forms.js.coffee</a>
        
          
          <a class="source" href="payments.js.coffee.html">0.1/samurai/payments.js.coffee</a>
        
          
          <a class="source" href="utilities.js.coffee.html">0.1/samurai/utilities.js.coffee</a>
        
          
          <a class="source" href="../../samurai.js.coffee.html">samurai.js.coffee</a>
        
      </div>
    </div>
  </div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>payment_error_handler.js.coffee</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    
    <tr id='section-Samurai_Payment_Error_Handler_Module'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Samurai_Payment_Error_Handler_Module">&#182;</a>
        </div>
        <h2>Samurai Payment Error Handler Module</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nv">$ = </span><span class="nx">jQuery</span></pre></div>
      </td>
    </tr>
    
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Module for handling errors returned by the Samurai Payment module</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nx">@module</span> <span class="s2">&quot;Samurai&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">log = </span><span class="nx">Samurai</span><span class="p">.</span><span class="nx">log</span>

  <span class="k">class</span> <span class="nx">@PaymentErrorHandler</span></pre></div>
      </td>
    </tr>
    
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Since error messages are returned in key form only,
we need to convert them to a human-readable form before we show
them to the user. This hash contains the default translations
for these keys. Feel free to overwrite it with your own.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="vi">@ERROR_MESSAGES = </span><span class="p">{</span>
      <span class="nv">summary_header: </span><span class="s1">&#39;We found some errors in the information you were trying to submit:&#39;</span>
      <span class="nv">not_numeric: </span><span class="s1">&#39;must be a number.&#39;</span>
      <span class="nv">too_short: </span><span class="s1">&#39;is too short.&#39;</span>
      <span class="nv">too_long: </span><span class="s1">&#39;is too long.&#39;</span>
      <span class="nv">failed_checksum: </span><span class="s1">&#39;is not valid.&#39;</span>
    <span class="p">}</span></pre></div>
      </td>
    </tr>
    
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Keeps a list of all instantiated error handlers.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="vi">@errorHandlers: </span><span class="p">[]</span> </pre></div>
      </td>
    </tr>
    
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Used to return a reference to the error handler of a form or
instantiate one if one doesn&#39;t exist, yet.
Make sure that the <code>element</code> argument is an actual DOM element
and not a jQuery collection.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="vi">@for: </span><span class="nf">(element) -&gt;</span>
      <span class="k">for</span> <span class="p">{</span><span class="nx">el</span><span class="p">,</span> <span class="nx">handler</span><span class="p">}</span> <span class="k">in</span> <span class="nx">PaymentErrorHandler</span><span class="p">.</span><span class="nx">errorHandlers</span>
        <span class="k">return</span> <span class="nx">handler</span> <span class="k">if</span> <span class="nx">el</span> <span class="o">is</span> <span class="nx">element</span>

      <span class="k">return</span> <span class="k">new</span> <span class="nx">PaymentErrorHandler</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Setup the error handler for <code>@form</code> and respond to the payment,
submit and show-error events.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">constructor: </span><span class="nf">(@form, @config={}) -&gt;</span></pre></div>
      </td>
    </tr>
    
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>You can pass your own config values to the constructor
if you&#39;re planning to let Samurai handle the display of errors,
but would just like to use different class names.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="vi">@config = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span>
        <span class="nv">inputErrorClass: </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
        <span class="nv">labelErrorClass: </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
        <span class="nv">descriptionClass: </span><span class="s1">&#39;error-description&#39;</span><span class="p">,</span>
        <span class="nv">errorSummaryClass: </span><span class="s1">&#39;error-summary&#39;</span>
        <span class="nx">@config</span><span class="p">)</span>

      <span class="vi">@form = </span><span class="nx">$</span><span class="p">(</span><span class="nx">@form</span><span class="p">)</span>
      <span class="nx">@form</span>
        <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;samurai.payment&#39;</span><span class="p">,</span> <span class="nx">@handlePaymentEvent</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">submit</span><span class="p">(</span><span class="nx">@reset</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;samurai.show-error&#39;</span><span class="p">,</span> <span class="nx">@highlightFieldWithErrors</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;samurai.errors-shown&#39;</span><span class="p">,</span> <span class="nx">@showErrorSummary</span><span class="p">)</span>
      <span class="vi">@currentErrorMessages = </span><span class="p">[]</span>
      <span class="nx">PaymentErrorHandler</span><span class="p">.</span><span class="nx">errorHandlers</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@form</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="k">this</span>
      <span class="nx">log</span> <span class="s1">&#39;Error handler attached to &#39;</span><span class="p">,</span> <span class="nx">@form</span></pre></div>
      </td>
    </tr>
    
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>This method simply passes the response on to the <code>handleErrorsFromResponse</code> method
in its default implementation, but you can always replace it with your own if you
need it to do more than that.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">handlePaymentEvent: </span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">@handleErrorsFromResponse</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Loops through the messages block and calls the <code>parseErrorMessage</code> method
for each message with a class of <code>error</code>. At the end of the method,
a <code>samurai.errors-shown</code> event is triggered, which we hook into to
provide users a summary of all errors.</p>

<p>This method will usually get called by handlePaymentEvent when a samurai.payment event
is triggered, but you can easily use it on its own like this:</p>

<p><code>Samurai.PaymentErrorHandler.for($(&#39;#myform&#39;)).handleErrorsFromResponse(jsonResponse)</code></p>

<p>Note that this method doesn&#39;t handle the display of errors.
When it finds an error, it triggers the <code>samurai.show-error</code> event and passes on
the affected input field and the humanized error message. This allows you to
intercept the <code>show-error</code> event and handle the display of errors yourself.
If not, the built-in <code>highlightFieldWithError</code> method will respond to this event 
and highlight the erroneous field in the default style.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">handleErrorsFromResponse: </span><span class="nf">(response) -&gt;</span>
      <span class="nv">messages = </span><span class="nx">response</span><span class="p">.</span><span class="nx">payment_method</span><span class="o">?</span><span class="p">.</span><span class="nx">messages</span> <span class="o">||</span> <span class="nx">response</span><span class="p">.</span><span class="nx">messages</span> <span class="o">||</span> <span class="p">[]</span> 
      <span class="k">for</span> <span class="nx">message</span> <span class="k">in</span> <span class="nx">messages</span>
        <span class="k">if</span> <span class="nx">message</span><span class="p">.</span><span class="k">class</span> <span class="o">is</span> <span class="s1">&#39;error&#39;</span>
          <span class="p">[</span><span class="nx">input</span><span class="p">,</span> <span class="nx">text</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@parseErrorMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
          <span class="nx">@form</span><span class="p">.</span><span class="nx">trigger</span> <span class="s1">&#39;samurai.show-error&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">input</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">message</span><span class="p">]</span>
          <span class="nx">@currentErrorMessages</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>

      <span class="k">if</span> <span class="nx">@currentErrorMessages</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nx">@form</span><span class="p">.</span><span class="nx">trigger</span> <span class="s1">&#39;samurai.errors-shown&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">@currentErrorMessages</span><span class="p">]</span></pre></div>
      </td>
    </tr>
    
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Returns a jQuery collection that contains the element with invalid value
and the humanized error text that corresponds to the message key</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">parseErrorMessage: </span><span class="nf">(message) -&gt;</span>
      <span class="p">[</span><span class="nx">context</span><span class="p">,</span> <span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
      <span class="nv">input = </span><span class="nx">@form</span><span class="p">.</span><span class="nx">find</span> <span class="s1">&#39;[name=&quot;credit_card[&#39;</span><span class="o">+</span><span class="nx">field</span><span class="o">+</span><span class="s1">&#39;]&quot;]&#39;</span>
      <span class="nv">text = </span><span class="nx">PaymentErrorHandler</span><span class="p">.</span><span class="nx">ERROR_MESSAGES</span><span class="p">[</span><span class="nx">message</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">input</span><span class="p">,</span> <span class="nx">text</span><span class="p">]</span></pre></div>
      </td>
    </tr>
    
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>The default error renderer for Samurai. Adds the <code>error</code> class names to the
input field and its nearest label.
It also triggers an <code>error-shown</code> event after these changes with the affected input element
and the error message as arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nv">highlightFieldWithErrors: </span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">addClass</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">inputErrorClass</span>
      <span class="nv">label = </span><span class="nx">input</span><span class="p">.</span><span class="nx">siblings</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">label</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nv">label = </span><span class="nx">input</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
      <span class="nx">label</span><span class="p">.</span><span class="nx">addClass</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">labelErrorClass</span>
      <span class="nx">@form</span><span class="p">.</span><span class="nx">trigger</span> <span class="s1">&#39;samurai.error-shown&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">input</span><span class="p">,</span> <span class="nx">text</span><span class="p">]</span>

    <span class="nv">showErrorSummary: </span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">messages</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">errors = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">message</span> <span class="k">in</span> <span class="nx">messages</span>
        <span class="p">[</span><span class="nx">input</span><span class="p">,</span> <span class="nx">text</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@parseErrorMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>try to find the nearest label to get the name of the field that contains
the error. If no label is around, default to the name inside the context
key of the returned message.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nv">label = </span><span class="nx">input</span><span class="p">.</span><span class="nx">siblings</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">label</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nv">label = </span><span class="nx">input</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">label</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="nv">fieldName = </span><span class="nx">message</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/_/</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nv">fieldName = </span><span class="nx">$</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">label</span><span class="p">.</span><span class="nx">text</span><span class="p">()).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/:$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># strip trailing colon from labels that have it</span>

        <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;&lt;li&gt;&lt;em class=\&quot;field-with-error-name\&quot;&gt;#{fieldName}&lt;/em&gt; #{text}&lt;/li&gt;&quot;</span>

      <span class="nv">errorContainerHTML = </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      &lt;div class=&quot;</span><span class="c1">#{@config.errorSummaryClass}&quot;&gt;</span>
        <span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="c1">#{PaymentErrorHandler.ERROR_MESSAGES.summary_header}&lt;/strong&gt;</span>
        <span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span></pre></div>
      </td>
    </tr>
    
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>{errors.join(&#39;&#39;)}</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="o">&lt;</span><span class="err">/ul&gt;</span>
      <span class="o">&lt;</span><span class="err">/div&gt;</span>
      <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">      @form</span>
<span class="s2">        .find(&#39;.&#39;+@config.errorSummaryClass).remove().end()</span>
<span class="s2">        .find(&#39;[type=&quot;</span><span class="nx">submit</span><span class="err">&quot;</span><span class="p">]</span><span class="s1">&#39;).last()</span>
<span class="s1">          .before(errorContainerHTML)</span>


<span class="s1"># DIVIDER</span>

<span class="s1">    reset: =&gt;</span>
<span class="s1">      @form</span>
<span class="s1">        .find(&#39;</span><span class="p">.</span><span class="s1">&#39;+@config.inputErrorClass).removeClass(@config.inputErrorClass).end()</span>
<span class="s1">        .find(&#39;</span><span class="p">.</span><span class="s1">&#39;+@config.labelErrorClass).removeClass(@config.labelErrorClass).end()</span>
<span class="s1">        .find(&#39;</span><span class="p">.</span><span class="s1">&#39;+@config.descriptionClass).remove().end()</span>
<span class="s1">        .find(&#39;</span><span class="p">.</span><span class="err">&#39;</span><span class="o">+</span><span class="nx">@config</span><span class="p">.</span><span class="nx">errorSummaryClass</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>
      <span class="vi">@currentErrorMessages = </span><span class="p">[]</span></pre></div>
      </td>
    </tr>
    
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Clears all errors and wipe the internal error message array.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    
  </table>
</div>
</body>
</html>